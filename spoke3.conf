#CONFIG SYS INT : LAN , WAN , VLANs 
#CONFIG SYS INT : VLANS & TUNNEL INT:
#CONFIG SYS INT : CONNECT TO INTERNET GUI
#DHCP
#CONFIG STATIC ROUTE
#CONFIGURE LAN ZONE 
#CONFIGURE VPN IPSEC PH1 & PH2
#CONFIG ROUTER BGP
########################################################################################################CONFIGURE INTERFACES VLANs and WAN 
#CONFIG SYS INT : CONFIG LAN , WAN , VLANs 
#######################################################################################################
config system interface
    edit "port2"
        set vdom "root"
        set ip 192.162.12.2 255.255.255.0
        set allowaccess ping https ssh snmp fgfm
        set type physical
        set alias "wan1"
        set lldp-reception enable
        set role wan
        set snmp-index 2
    next
    edit "port4"
        set vdom "root"
        set ip 12.1.2.2 255.255.255.0
        set allowaccess ping https ssh snmp fgfm
        set type physical
        set alias "wan2"
        set lldp-reception enable
        set role wan
        set snmp-index 4
    next
end
########################################################################################################
#CONFIG SYS INT : VLANS & Tunnel Interface:
########################################################################################################
config system interface
    edit "VLAN_99"
        set vdom "root"
        set ip 172.150.4.113 255.255.255.240
        set allowaccess ping https ssh snmp fgfm ftm
        set alias "native"
        set device-identification enable
        set role lan
        set snmp-index 13
        set interface "port3"
        set vlanid 99
    next
    edit "VLAN_10"
        set vdom "root"
        set ip 172.150.4.1 255.255.255.192
        set allowaccess ping https ssh snmp
        set alias "vlan10"
        set device-identification enable
        set role lan
        set snmp-index 14
        set interface "port3"
        set vlanid 10
    next
    edit "VLAN_30"
        set vdom "root"
        set ip 172.150.4.65 255.255.255.224
        set allowaccess ping https ssh snmp
        set alias "vlan30"
        set device-identification enable
        set role lan
        set snmp-index 15
        set interface "port3"
        set vlanid 30
    next
    edit "VLAN_101"
        set vdom "root"
        set ip 172.150.4.97 255.255.255.240
        set allowaccess ping https ssh snmp fgfm
        set alias "vlan101"
        set device-identification enable
        set role lan
        set snmp-index 16
        set interface "port3"
        set vlanid 101
    next
    edit "spoke3"
        set vdom "root"
        set ip 10.10.10.3 255.255.255.255
        set allowaccess ping
        set type tunnel
        set remote-ip 10.10.10.1 255.255.255.0
        set snmp-index 17
        set interface "port2"
    next
    edit "spoke3_backup"
        set vdom "root"
        set ip 10.10.20.3 255.255.255.255
        set allowaccess ping
        set type tunnel
        set remote-ip 10.10.20.1 255.255.255.0
        set snmp-index 18
        set interface "port4"
    next
end 
#######################################################################################################
 #CONNECT TO INTERNET GUI
#######################################################################################################
config system interface
    edit "port10"
        set vdom "root"
        set ip 192.168.1.103 255.255.255.0
        set allowaccess ping https ssh http
        set type physical
        set snmp-index 10
    next
end

#######################################################################################################
#DHCP
#######################################################################################################
config system dhcp server
    edit 1
        set ntp-service local
        set default-gateway 10.255.1.1
        set netmask 255.255.255.0
        set interface "fortilink"
        config ip-range
            edit 1
                set start-ip 10.255.1.2
                set end-ip 10.255.1.254
            next
        end
        set vci-match enable
        set vci-string "FortiSwitch" "FortiExtender"
    next
    edit 2
        set dns-service default
        set default-gateway 172.150.4.65
        set netmask 255.255.255.224
        set interface "VLAN_30"
        config ip-range
            edit 1
                set start-ip 172.150.4.66
                set end-ip 172.150.4.94
            next
        end
    next
    edit 3
        set dns-service default
        set default-gateway 172.150.4.1
        set netmask 255.255.255.192
        set interface "VLAN_10"
        config ip-range
            edit 1
                set start-ip 172.150.4.2
                set end-ip 172.150.4.62
            next
        end
    next
    edit 4
        set dns-service default
        set default-gateway 172.150.4.97
        set netmask 255.255.255.240
        set interface "VLAN_101"
        config ip-range
            edit 1
                set start-ip 172.150.4.98
                set end-ip 172.150.4.110
            next
        end
    next
    edit 5
        set dns-service default
        set default-gateway 172.150.4.113
        set netmask 255.255.255.240
        set interface "VLAN_99"
        config ip-range
            edit 1
                set start-ip 172.150.4.114
                set end-ip 172.150.4.126
            next
        end
    next
end
#######################################################################################################
#CONFIGURE LAN ZONE 
#######################################################################################################
config system zone
    edit "teta_lan"
        set intrazone allow
        set interface "VLAN_10" "VLAN_30" "VLAN_99" "VLAN_101" "port3"
    next
end
#######################################################################################################  
#CONFIG VPN IPSEC PH1 & PH2
#######################################################################################################
config vpn ipsec phase1-interface
    edit "spoke3"
        set interface "port2"
        set ike-version 2
        set peertype any
        set net-device enable
        set proposal des-sha1 des-sha384 des-sha512 des-md5
        set add-route disable
        set dpd on-idle
        set auto-discovery-receiver enable
        set fec-egress enable
        set fec-ingress enable
        set remote-gw 192.162.254.2
        set psksecret ENC xjhRocvNfjeAcM5i3hPmQeMmR/9jp0SOP0AwPXDy/VPcaQRBTuFpM/6E0UNETk9QZXOjtAZHDpqsYuAO/tTJAK/QRHPqgUkOL1MtLqqHf5VZvbvymp3y8zNZkInlz97M7iyuojakUbySSw0GL9+tTp8dVUxLgSp7iKtbSM6UmzgAbqziyZfdWWLQMyKiWgkCcBIUZw==
        set dpd-retryinterval 5
    next
    edit "spoke3_backup"
        set interface "port4"
        set ike-version 2
        set peertype any
        set net-device enable
        set proposal des-sha1 des-sha384 des-sha512 des-md5
        set add-route disable
        set dpd on-idle
        set auto-discovery-receiver enable
        set fec-egress enable
        set fec-ingress enable
        set remote-gw 12.1.254.2
        set monitor "spoke3"
        set psksecret ENC N+qbciLdUo1bWOu2/2rOBhPKI2IHk5GanH6uAO/M+qIEFTemPGxW2CQ0CbbA9nLfJLFxhFihbyRG9sp/e1EH2ggMxzh8uzaH6Ra1qB36IvbOX+/Ms0YC02zCbOjzCOALomavAwCYJuVudp65dZELFN+DDgLKZKTc+kZ+pKyBrPOj+J0bP0+ESGfscSaISRwMOF2OFw==
        set dpd-retryinterval 5
    next
end
config vpn ipsec phase2-interface
    edit "spoke3"
        set phase1name "spoke3"
        set proposal des-sha256 des-sha1
        set auto-negotiate enable
        set src-subnet 10.10.10.0 255.255.255.0
        set dst-subnet 10.10.10.0 255.255.255.0
    next
    edit "spoke3_backup"
        set phase1name "spoke3_backup"
        set proposal des-sha256 des-sha1
        set auto-negotiate enable
        set src-subnet 10.10.20.0 255.255.255.0
        set dst-subnet 10.10.20.0 255.255.255.0
    next
end

########################################################################################################CONFIGURE INTERFACES VLANs and WAN 
#CONFIG ROUTER BGP 
#######################################################################################################

config router bgp
    set as 65412
    set router-id 3.3.3.3
    set ibgp-multipath enable
    config neighbor
        edit "10.10.10.1"
            set advertisement-interval 1
            set link-down-failover enable
            set interface "spoke3"
            set remote-as 65412
            set update-source "spoke3"
        next
        edit "10.10.20.1"
            set advertisement-interval 1
            set link-down-failover enable
            set interface "spoke3_backup"
            set remote-as 65412
            set update-source "spoke3_backup"
        next
    end
    config network
        edit 2
            set prefix 172.150.4.64 255.255.255.224
        next
        edit 3
            set prefix 172.150.4.96 255.255.255.240
        next
        edit 4
            set prefix 172.150.4.112 255.255.255.240
        next
        edit 1
            set prefix 172.150.4.0 255.255.255.192
        next
    end
    config network6
        edit 1
            set prefix6 ::/128
        next
    end
    config redistribute "connected"
    end
    config redistribute "rip"
    end
    config redistribute "ospf"
    end
    config redistribute "static"
    end
    config redistribute "isis"
    end
    config redistribute6 "connected"
    end
    config redistribute6 "rip"
    end
    config redistribute6 "ospf"
    end
    config redistribute6 "static"
    end
    config redistribute6 "isis"
    end
end
config router isis
    config redistribute "connected"
    end
    config redistribute "rip"
    end
    config redistribute "ospf"
    end
    config redistribute "bgp"
    end
    config redistribute "static"
    end
    config redistribute6 "connected"
    end
    config redistribute6 "rip"
    end
    config redistribute6 "ospf"
    end
    config redistribute6 "bgp"
    end
    config redistribute6 "static"
    end
end
config router multicast
end

########################################################################################################
#SDWAN
########################################################################################################
config system sdwan
    set status enable
    set load-balance-mode weight-based
    config zone
        edit "virtual-wan-link"
        next
        edit "VPN"
        next
    end
    config members
        edit 1
            set interface "spoke3"
            set zone "VPN"
        next
        edit 2
            set interface "spoke3_backup"
            set zone "VPN"
        next
    end
    config health-check
        edit "Default_DNS"
            set system-dns enable
            set interval 1000
            set probe-timeout 1000
            set recoverytime 10
            config sla
                edit 1
                    set latency-threshold 250
                    set jitter-threshold 50
                    set packetloss-threshold 5
                next
            end
        next
        edit "Default_Office_365"
            set server "www.office.com"
            set protocol http
            set interval 1000
            set probe-timeout 1000
            set recoverytime 10
            config sla
                edit 1
                    set latency-threshold 250
                    set jitter-threshold 50
                    set packetloss-threshold 5
                next
            end
        next
        edit "Default_Gmail"
            set server "gmail.com"
            set interval 1000
            set probe-timeout 1000
            set recoverytime 10
            config sla
                edit 1
                    set latency-threshold 250
                    set jitter-threshold 50
                    set packetloss-threshold 2
                next
            end
        next
        edit "Default_AWS"
            set server "aws.amazon.com"
            set protocol http
            set interval 1000
            set probe-timeout 1000
            set recoverytime 10
            config sla
                edit 1
                    set latency-threshold 250
                    set jitter-threshold 50
                    set packetloss-threshold 5
                next
            end
        next
        edit "Default_Google Search"
            set server "www.google.com"
            set protocol http
            set interval 1000
            set probe-timeout 1000
            set recoverytime 10
            config sla
                edit 1
                    set latency-threshold 250
                    set jitter-threshold 50
                    set packetloss-threshold 5
                next
            end
        next
        edit "Default_FortiGuard"
            set server "fortiguard.com"
            set protocol http
            set interval 1000
            set probe-timeout 1000
            set recoverytime 10
            config sla
                edit 1
                    set latency-threshold 250
                    set jitter-threshold 50
                    set packetloss-threshold 5
                next
            end
        next
        edit "SLA"
            set server "172.150.1.1"
            set members 1 2
            config sla
                edit 1
                    set latency-threshold 500
                    set jitter-threshold 500
                    set packetloss-threshold 25
                next
            end
        next
    end
    config service
        edit 1
            set name "LB"
            set mode load-balance
            set dst "all"
            set src "all"
            config sla
                edit "SLA"
                    set id 1
                next
            end
            set priority-members 1 2
        next
    end
end
