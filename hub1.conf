######################################################################
#IPSec phase 1 , phase 2
######################################################################
config vpn ipsec phase1-interface
    edit advpn-hub1
        set type dynamic
        set interface port2
        set peertype any
        set net-device disable
        set proposal des-sha256 des-sha1
        set add-route disable
        set dpd on-idle
        set auto-discovery-sender enable
        set psksecret sample
        set dpd-retryinterval 5
    next
end
config vpn ipsec phase2-interface
    edit advpn-hub1
        set phase1name advpn-hub1
        set proposal des-sha256 des-sha1
    next
end

config vpn ipsec phase1-interface
    edit advpn2-hub1
        set type dynamic 
        set interface port4
        set peertype any
        set net-device disable  
        set proposal des-sha256 des-sha1
        set add-route disable 
        set dpd on-idle
        set auto-discovery-sender enable
        set psksecret sample
        set dpd-retryinterval 5
    next
end
config vpn ipsec phase2-interface
    edit advpn2-hub1
        set phase1name advpn2-hub1
        set proposal des-sha256 des-sha1
    next
end

######################################################################
#FIREWALL POLICIES
######################################################################
config vpn ipsec phase1-interface
    edit advpn-hub1
        set type dynamic #It is a dynamic (dial-up) tunnel
        set interface port2
        set peertype any #  which accepts negotiation from any spokes.
        set net-device disable #activating fortigate's new dial-up logic
        set proposal des-sha256 des-sha1
        set add-route disable # No reverse route injection, routing table will be built by routing protocol
        set dpd on-idle
        set auto-discovery-sender enable
        set tunnel-search nexthop
        set psksecret sample
        set dpd-retryinterval 5
    next
end
config vpn ipsec phase2-interface
    edit advpn-hub1
        set phase1name advpn-hub1
        set proposal des-sha256 des-sha1
    next
end
config vpn ipsec phase1-interface
    edit advpn2-hub1
        set type dynamic 
        set interface port4
        set peertype any
        set net-device disable  
        set proposal des-sha256 des-sha1
        set add-route disable 
        set dpd on-idle
        set auto-discovery-sender enable
        set psksecret sample
        set dpd-retryinterval 5
    next
end
config vpn ipsec phase2-interface
    edit advpn2-hub1
        set phase1name advpn2-hub1
        set proposal des-sha256 des-sha1
    next
end

######################################################################
#IPSEC TUNNEL INTERFACE IP ADDRESS  _ SPOKE
######################################################################
config system interface
    edit advpn-hub1
        set vdom root
        set ip 10.10.10.254 255.255.255.255
        set remote-ip 10.10.10.253 255.255.255.0
    next
    edit advpn2-hub1
        set vdom root
        set ip 10.10.20.254 255.255.255.255
        set remote-ip 10.10.20.253 255.255.255.0
    next
end

######################################################################
#CONFIG THE HUB FORTIGATE BGP
######################################################################
config router bgp
    set as 65412
    set router-id 11.11.11.11
    set ibgp-multipath enable
    set additional-path enable
    set additional-path-select 2
    config neighbor-group
        edit advpn
            set capability-default-originate enable
            set remote-as 65412
            set route-reflector-client enable
            set additional-path both
            set adv-additional-path 2
        next
    end
    config neighbor-range
        edit 1
            set prefix 10.10.0.0 255.255.0.0
            set neighbor-group "advpn"
        next
    end
    config network
        edit 1
            set prefix 172.150.1.0 255.255.255.192
        next
        edit 2
            set prefix 172.150.1.64 255.255.255.224
        next
        edit 3
            set prefix 172.150.1.112 255.255.255.240
        next
    end
end